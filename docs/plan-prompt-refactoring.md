# Plan 提示词重构说明

## 重构日期
2026-03-01

## 重构目标

根据 morty 文档中的 plan 格式规范和拓扑依赖执行机制，重构 `prompts/plan.md` 提示词，确保：
1. AI 生成的 plan 文件严格符合格式规范
2. 通过 `morty plan validate --verbose` 自动验证
3. AI 自动修复格式错误，不再依赖 `--fix` 模式
4. 统一命名规范，确保拓扑依赖正确执行

---

## 主要变更

### 1. ✅ 删除 `--fix` 模式，改为 AI 自动修复

**变更前**:
- 提示词中没有提到格式验证
- 依赖用户手动运行 `morty plan validate --fix`

**变更后**:
- 新增 `step7: [格式验证]` - 自动运行 `morty plan validate --verbose`
- 新增 `step8: [修复错误]` - AI 根据错误信息自动修复
- 循环执行验证和修复，直到所有文件通过验证
- 验证器第 8 条: "如果 `morty plan validate --verbose` 验证失败,则检查不通过"

**影响**:
- AI 必须确保生成的文件通过验证才能结束 plan 模式
- 减少用户手动干预，提高自动化程度

---

### 2. ✅ 删除"生产测试" section，改为 e2e_test 模块

**变更前**:
```markdown
## 4. [生产测试].md 文件格式规范

这是一个特殊的 Plan 文件...

### 文件模板
[包含特殊的 section 结构]
```

**变更后**:
```markdown
## 4. e2e_test.md 文件格式规范

这是一个特殊的模块,必须作为所有功能模块完成后的最后一个模块。

**重要**: `e2e_test.md` 的格式与普通模块完全一致,只是:
- 文件名特殊（e2e_test）
- 依赖模块应该是 `__ALL__`（依赖所有其他模块）
- 最后一个 Job 也必须是"集成测试"
```

**影响**:
- `e2e_test.md` 现在是一个普通的模块文件
- 使用与其他模块完全相同的格式
- 通过 `__ALL__` 依赖确保它在最后执行
- 保持格式一致性，简化 parser 和 validator 的实现
- 文件名遵循小写+下划线规范

---

### 3. ✅ 删除"集成测试" section，改为最后一个 Job

**变更前**:
```markdown
## 集成测试

**触发条件**: 模块内所有 Jobs 完成

**验证器**:
[验证标准列表]
```

**变更后**:
```markdown
### Job N: 集成测试

#### 目标
验证模块内所有 Jobs 协同工作正确...

#### 前置条件
- job_1 - 第一个 Job 完成
- job_2 - 第二个 Job 完成
...

#### Tasks
- [ ] Task 1: 验证模块所有公开接口可以被正常调用
...

#### 验证器
- 模块所有公开接口可以被正常调用
...

#### 调试日志
无

#### 完成状态
⏳ 待开始
```

**影响**:
- 集成测试现在是一个标准的 Job，编号为 N（最后一个）
- 与其他 Jobs 使用相同的格式和字段
- 可以被 morty 的执行引擎正确调度
- 前置条件明确列出所有前面的 Jobs

---

### 4. ✅ 强化命名规范的一致性

**新增的命名规范要求**:

#### 文件名
- 格式: `^[a-z0-9_]+\.md$`
- 示例: `user_auth.md`, `data_processor.md`, `api_v2.md`
- 禁止: 大写字母、连字符、中文
- 特例: `e2e_test.md` (端到端测试模块，必需)

#### 模块名（依赖声明）
- 格式: `^[a-z0-9_]+$`
- 使用文件名（不含 `.md`）
- 示例: `user_auth`, `data_processor`
- 禁止: 大写字母、连字符、中文

#### 依赖模块格式
```markdown
**依赖模块**: 无                          # 无依赖
**依赖模块**: user_auth                   # 单个依赖
**依赖模块**: user_auth, data_processor   # 多个依赖
**依赖模块**: __ALL__                     # 依赖所有模块
```

#### Job 前置条件格式
```markdown
#### 前置条件

无                                        # 无前置条件

- job_1 - 描述                           # 同模块依赖
- user_auth:job_2 - 描述                 # 跨模块依赖
- 其他自然语言描述                        # 非 Job 依赖
```

#### Task 格式
```markdown
- [ ] Task 1: 任务描述                   # 未完成
- [x] Task 2: 任务描述                   # 已完成（小写 x）
```

#### 完成状态标记
```markdown
⏳ 待开始    # 默认
🚧 进行中
⏸️ 暂停
❌ 失败
✅ 已完成
```

---

### 5. ✅ 新增错误修复指南

新增 `## 8. 错误修复指南` section，包含所有错误代码的修复方法:

#### E001: 文件名不符合规范
- 错误示例: `UserAuth.md`
- 修复方法: 重命名为 `user_auth.md`

#### E004: Job 编号不连续
- 错误示例: Job 1 → Job 3
- 修复方法: 重新编号为 Job 1 → Job 2

#### E005: 依赖模块格式错误
- 错误示例: `**依赖模块**: UserAuth`
- 修复方法: `**依赖模块**: user_auth`

#### E006: Task 格式错误
- 错误示例: `- [ ] 创建文件`
- 修复方法: `- [ ] Task 1: 创建文件`

#### E007: 前置条件格式错误
- 错误示例: `- Job 1 完成`
- 修复方法: `- job_1 - 完成`

#### E008: 完成状态标记无效
- 错误示例: `已完成`
- 修复方法: `⏳ 待开始`

#### E009: 调试日志格式错误
- 要求: 6 个字段或写"无"
- 格式: `debug1: 现象, 复现, 猜想, 验证, 修复, 进展`

每个错误都包含:
- 错误示例
- 修复方法
- 正确格式说明

---

### 6. ✅ 更新文件模板

#### 模块文件模板更新
- 所有 H4 标题改为独立行（如 `#### 目标`）
- 字段值在标题下方独立段落
- 前置条件、Tasks、验证器使用列表格式
- 新增"完成状态" section（必需）
- "调试日志"必须写"无"或包含完整格式的 debug 日志

#### README.md 模板更新
- 依赖模块列使用文件名（不含 .md）
- 添加表格说明，明确各列含义
- 依赖关系图使用文件名
- 执行顺序使用文件名
- 新增"说明"段落，解释执行机制

---

### 7. ✅ 更新设计原则

#### Job 设计原则新增
- **格式严格**: 严格遵循格式规范
  - Job 编号从 1 开始连续
  - Task 必须包含 `Task N:` 前缀
  - 前置条件使用标准格式
  - 完成状态使用标准标记
  - 调试日志包含 6 个字段或写"无"

#### 验证器设计原则新增
- **列表形式**: 使用无序列表而非段落

#### 模块划分原则新增
- **命名规范**: 使用小写字母、数字、下划线
- **集成测试**: 每个模块的最后一个 Job 必须是"集成测试"
- **E2E测试**: 最后必须有 `e2e_test.md` 模块，依赖所有其他模块

---

### 8. ✅ 更新交互流程

新增步骤:
```
7. **写入文件**: 用户确认后，生成所有 `.morty/plan/*.md` 文件
8. **格式验证**: 运行 `morty plan validate --verbose` 验证所有文件
9. **修复错误**: 如果验证失败，根据错误信息自动修复，然后重新验证
10. **完成确认**: 所有文件通过验证后，输出完成信号
```

**重要**: 步骤 8-9 是自动化的，不需要用户干预。

---

### 9. ✅ 更新输出信号

新增检查项:
```markdown
**格式验证**: ✅ 所有文件通过 `morty plan validate --verbose` 检查

**生成的模块**: [N] 个
- [模块A]: [N] 个 Jobs（最后一个为集成测试）
- [模块B]: [M] 个 Jobs（最后一个为集成测试）
- e2e_test: [K] 个 Jobs（最后一个为集成测试）

**命名规范检查**:
- ✅ 所有文件名使用小写+下划线
- ✅ 所有模块依赖使用小写+下划线
- ✅ 所有 Job 前置条件格式正确
- ✅ 所有 Task 包含编号前缀
- ✅ 所有完成状态使用标准标记
```

---

### 10. ✅ 更新禁止事项

新增:
- **不要跳过验证**: 生成文件后必须运行 `morty plan validate --verbose` 验证
- **不要忽略错误**: 验证失败时必须根据错误信息修复，不能跳过
- **不要违反命名规范**: 所有文件名、模块名、依赖名必须使用小写+下划线

---

## 向后兼容性

### 保持兼容
- ✅ 基本的 plan 文件结构不变
- ✅ 模块概述、接口定义、数据模型 sections 保持不变
- ✅ Job 的核心字段（目标、Tasks、验证器）保持不变
- ✅ README.md 的核心内容保持不变

### 不兼容变更
- ❌ "集成测试" section 改为最后一个 Job
- ❌ 端到端测试模块改名为 `e2e_test.md`（不再使用 `[生产测试].md`）
- ❌ 所有文件必须通过格式验证
- ❌ 命名规范更严格（必须小写+下划线）

### 迁移建议

对于现有的 plan 文件:
1. 运行 `morty plan validate --verbose` 检查错误
2. 根据错误修复指南手动修复
3. 将"集成测试" section 改为最后一个 Job
4. 确保 `[生产测试].md` 使用标准格式
5. 检查所有命名是否符合规范

---

## 测试建议

### 1. 格式验证测试
```bash
# 生成新的 plan 文件
morty plan

# AI 应该自动运行验证并修复错误
# 最终输出应包含: "格式验证: ✅ 所有文件通过检查"

# 手动验证
morty plan validate --verbose
```

### 2. 命名规范测试
检查生成的文件:
- 所有文件名是否使用小写+下划线
- README.md 中的依赖模块名是否正确
- Job 前置条件格式是否正确

### 3. 集成测试 Job 测试
检查每个模块:
- 最后一个 Job 是否名为"集成测试"
- 前置条件是否列出所有前面的 Jobs
- 格式是否与其他 Jobs 一致

### 4. E2E测试模块测试
检查 `e2e_test.md`:
- 格式是否与普通模块一致
- 依赖模块是否为 `__ALL__`
- 最后一个 Job 是否为"集成测试"
- 文件名是否符合小写+下划线规范

---

## 相关文件

### 修改的文件
- `prompts/plan.md` - Plan 提示词（重构）

### 参考文档
- `docs/PLAN_FORMAT_GUIDE.md` - Plan 格式指南
- `docs/plan_format_spec.md` - Plan 格式规范 v2.0
- `docs/improvements-summary.md` - Morty 改进总结
- `internal/validator/plan_validator.go` - Plan 验证器实现
- `internal/cmd/plan.go` - Plan 命令实现

---

## 后续改进建议

### 1. 增强错误提示
- 在验证失败时，直接在提示词中展示修复示例
- 提供交互式修复建议

### 2. 自动化测试
- 添加 plan 提示词的集成测试
- 验证生成的文件是否符合规范

### 3. 文档同步
- 确保 PLAN_FORMAT_GUIDE.md 与提示词保持一致
- 更新示例文件

### 4. 用户体验
- 提供 plan 文件模板生成工具
- 添加 plan 文件可视化工具

---

## 总结

本次重构的核心目标是**确保 AI 生成的 plan 文件严格符合格式规范**，通过:

1. **自动验证**: 集成 `morty plan validate --verbose` 到 plan 生成流程
2. **自动修复**: AI 根据错误信息自动修复，无需用户干预
3. **统一格式**: 集成测试和生产测试使用标准格式，保持一致性
4. **严格命名**: 强制使用小写+下划线，确保拓扑依赖正确

这些改进使得 morty 能够更可靠地执行 plan，减少格式错误导致的执行失败。
