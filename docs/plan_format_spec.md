# Plan 文件格式规范 v2.0

## 概述

本规范定义了 Morty Plan 文件的严格格式要求，消除解析歧义，确保自动化工具能正确处理。

---

## 1. 文件命名规范

### 1.1 模块文件命名

**规则**: 使用小写字母、数字和下划线，扩展名为 `.md`

**格式**: `^[a-z0-9_]+\.md$`

**示例**:
- ✅ `user_auth.md`
- ✅ `data_processor.md`
- ✅ `api_v2.md`
- ❌ `UserAuth.md` (大写字母)
- ❌ `user-auth.md` (连字符)
- ❌ `用户认证.md` (中文)

### 1.2 特殊文件

- `README.md` - Plan 索引文件（必需）
- `[生产测试].md` - 端到端测试模块（必需，唯一允许使用方括号和中文的文件名）

---

## 2. 模块文件结构

### 2.1 必需 Section（按顺序）

```markdown
# Plan: [模块名称]

## 模块概述

## 接口定义

## 数据模型

## Jobs

### Job 1: [Job名称]

#### 目标

#### 前置条件

#### Tasks

#### 验证器

#### 调试日志

#### 完成状态

---

### Job 2: [Job名称]
...

---

## 集成测试
```

### 2.2 Section 层级规则

| Section | Heading Level | 父 Section | 必需 |
|---------|---------------|------------|------|
| Plan 标题 | `#` (H1) | - | ✅ |
| 模块概述 | `##` (H2) | - | ✅ |
| 接口定义 | `##` (H2) | - | ✅ |
| 数据模型 | `##` (H2) | - | ✅ |
| Jobs | `##` (H2) | - | ✅ |
| Job N | `###` (H3) | Jobs | ✅ |
| 目标 | `####` (H4) | Job N | ✅ |
| 前置条件 | `####` (H4) | Job N | ✅ |
| Tasks | `####` (H4) | Job N | ✅ |
| 验证器 | `####` (H4) | Job N | ✅ |
| 调试日志 | `####` (H4) | Job N | ✅ |
| 完成状态 | `####` (H4) | Job N | ✅ |
| 集成测试 | `##` (H2) | - | ✅ |

---

## 3. 模块概述格式

### 3.1 必需字段

```markdown
## 模块概述

**模块职责**: [一句话描述，不超过100字]

**对应 Research**: [引用列表，每项一行]
- `.morty/research/file1.md` - [简短描述]
- `.morty/research/file2.md` - [简短描述]

**现有实现参考**: [引用列表或"无"]
- `path/to/file.go` - [简短描述]

**依赖模块**: [依赖列表或"无"]

**被依赖模块**: [依赖列表或"无"]
```

### 3.2 依赖模块格式

**规则**:
- 如果没有依赖: 必须写 `**依赖模块**: 无`
- 如果有依赖: 使用逗号分隔的模块名列表
- 如果依赖所有其他模块: 使用 `__ALL__`
- 模块名使用文件名（不含 `.md` 扩展名）

**格式**: `^([a-z0-9_]+(, [a-z0-9_]+)*|无|__ALL__)$`

**示例**:
```markdown
**依赖模块**: 无

**依赖模块**: user_auth, data_processor

**依赖模块**: __ALL__
```

**错误示例**:
- ❌ `**依赖模块**:` (缺少值)
- ❌ `**依赖模块**: 用户认证` (中文)
- ❌ `**依赖模块**: UserAuth` (大写)
- ❌ `**依赖模块**: user_auth data_processor` (缺少逗号)

---

## 4. Job 格式

### 4.1 Job 标题

**格式**: `### Job [N]: [Job名称]`

**规则**:
- `N` 必须是从 1 开始的连续整数
- Job 名称使用中文或英文，清晰描述任务
- Job 之间必须使用 `---` 分隔符

**示例**:
```markdown
---

### Job 1: Mock AI CLI 实现

...

---

### Job 2: 测试辅助函数库

...

---
```

### 4.2 目标

**格式**:
```markdown
#### 目标

[一句话描述，不超过200字]
```

**规则**:
- 必须是纯文本，单段落
- 不允许使用列表或多段落

### 4.3 前置条件

**格式**:
```markdown
#### 前置条件

- [条件1]
- [条件2]
```

**无前置条件**:
```markdown
#### 前置条件

无
```

**Job 依赖格式**:
- 同模块依赖: `job_N` (例如: `job_1`, `job_2`)
- 跨模块依赖: `模块名:job_N` (例如: `user_auth:job_1`)
- 可以包含描述: `job_N - 描述文本`

**正则**: `^(job_\d+|[a-z0-9_]+:job_\d+)( - .+)?$`

**示例**:
```markdown
#### 前置条件

- job_1 - Mock CLI 实现完成
- user_auth:job_3 - 用户认证模块完成
- 所有配置文件就绪
```

### 4.4 Tasks

**格式**:
```markdown
#### Tasks

- [ ] Task 1: [任务描述]
- [ ] Task 2: [任务描述]
- [x] Task 3: [任务描述]
```

**规则**:
- 必须使用 `- [ ]` 或 `- [x]` 格式
- 必须包含 `Task N:` 前缀，N 从 1 开始连续
- `[x]` 表示已完成，`[ ]` 表示未完成
- 每个 Task 占一行

**正则**: `^- \[([ x])\] Task \d+: .+$`

**错误示例**:
- ❌ `- [ ] 任务描述` (缺少 Task N:)
- ❌ `- [X] Task 1: 描述` (大写 X)
- ❌ `1. [ ] Task 1: 描述` (使用有序列表)

### 4.5 验证器

**格式**:
```markdown
#### 验证器

- [验证标准1]
- [验证标准2]
- [验证标准3]
```

**规则**:
- 使用无序列表
- 每项使用自然语言描述
- 应包含可验证的标准（输入/输出、性能指标、边界条件等）

**示例**:
```markdown
#### 验证器

- Mock CLI 被调用时，根据输入内容识别场景（research/plan/doing）
- 返回对应的预定义内容，格式正确
- 记录调用日志到 /tmp/mock_claude.log
- 退出码为 0 表示成功
- 模拟延迟可配置，默认 0.5 秒
```

### 4.6 调试日志

**格式**:
```markdown
#### 调试日志

- debug1: [现象], [复现], [猜想], [验证], [修复], [进展]
- debug2: [现象], [复现], [猜想], [验证], [修复], [进展]
```

**无调试日志**:
```markdown
#### 调试日志

无
```

**规则**:
- 使用 `debugN:` 前缀，N 从 1 开始连续
- 6 个字段用逗号分隔: 现象、复现、猜想、验证、修复、进展
- 如果没有调试日志，必须写 `无`

**正则**: `^debug\d+: .+, .+, .+, .+, .+, .+$`

**示例**:
```markdown
#### 调试日志

- debug1: pytest 未安装导致测试失败, 运行 pytest 命令报错, 环境依赖缺失, 检查 requirements.txt, 添加 pytest 依赖, 已修复
- debug2: 表格对齐问题, 中文字符宽度计算错误, len() 计算字节数而非显示宽度, 实现 displayWidth() 函数, 使用 CJK 字符宽度计算, 已修复
```

### 4.7 完成状态

**格式**:
```markdown
#### 完成状态

[状态标记]
```

**允许的状态标记**:
- `✅ 已完成` - Job 完全完成
- `🚧 进行中` - Job 正在执行
- `⏸️ 暂停` - Job 暂停
- `❌ 失败` - Job 执行失败
- `⏳ 待开始` - Job 未开始（默认）

**规则**:
- 必须使用上述标记之一
- 可以在标记后添加补充说明
- 只有 `✅ 已完成` 会被识别为完成状态

**示例**:
```markdown
#### 完成状态

✅ 已完成

#### 完成状态

🚧 进行中 - Task 3 正在执行

#### 完成状态

⏳ 待开始
```

---

## 5. 集成测试格式

```markdown
## 集成测试

**触发条件**: [触发条件描述]

**验证器**:
- [验证标准1]
- [验证标准2]
```

**示例**:
```markdown
## 集成测试

**触发条件**: 模块内所有 Jobs 完成

**验证器**:
- 模块所有公开接口可以被正常调用
- 模块内部各 Job 协同工作产生正确结果
- 处理典型业务场景时表现符合预期
- 错误处理机制正常工作
```

---

## 6. README.md 格式

### 6.1 必需 Section

```markdown
# Plan 索引

**生成时间**: [ISO8601 时间戳]

**对应 Research**: [列表]

**现有实现探索**: [是/否]

## 模块列表

| 模块名称 | 文件 | Jobs 数量 | 依赖模块 | 状态 |
|----------|------|-----------|----------|------|
| ... | ... | ... | ... | ... |

## 依赖关系图

## 执行顺序

## 统计信息
```

### 6.2 模块列表表格

**列定义**:
1. **模块名称**: 模块的中文或英文名称
2. **文件**: 模块文件名（含 `.md` 扩展名）
3. **Jobs 数量**: 整数
4. **依赖模块**: `无` 或逗号分隔的模块名，或 `所有模块`
5. **状态**: `规划中` | `开发中` | `已完成` | `已暂停`

**示例**:
```markdown
| 模块名称 | 文件 | Jobs 数量 | 依赖模块 | 状态 |
|----------|------|-----------|----------|------|
| 用户认证 | user_auth.md | 5 | 无 | 开发中 |
| 数据处理 | data_processor.md | 3 | user_auth | 规划中 |
| 生产测试 | [生产测试].md | 2 | 所有模块 | 规划中 |
```

### 6.3 统计信息格式

```markdown
## 统计信息

- **总模块数**: [N]
- **总 Jobs 数**: [M]
- **预计执行轮次**: [L] 轮
- **探索子代理使用**: [是/否]
```

---

## 7. 格式验证规则

### 7.1 文件级验证

- [ ] 文件名符合命名规范
- [ ] 文件编码为 UTF-8
- [ ] 文件以 `# Plan:` 开头
- [ ] 包含所有必需的 H2 sections
- [ ] Section 顺序正确

### 7.2 模块概述验证

- [ ] 包含所有必需字段（模块职责、对应 Research、依赖模块、被依赖模块）
- [ ] 依赖模块格式正确
- [ ] 模块职责不超过 100 字

### 7.3 Job 验证

- [ ] Job 编号从 1 开始连续
- [ ] 每个 Job 包含所有必需的 H4 sections
- [ ] Job 之间使用 `---` 分隔
- [ ] Tasks 格式正确（`- [ ] Task N:`）
- [ ] 前置条件格式正确（job_N 或 module:job_N）
- [ ] 完成状态使用允许的标记

### 7.4 README 验证

- [ ] 包含所有必需 sections
- [ ] 模块列表表格格式正确
- [ ] 表格中的文件名与实际文件匹配
- [ ] 依赖关系与模块文件中的声明一致
- [ ] Jobs 数量统计正确

---

## 8. 错误代码

| 代码 | 错误类型 | 说明 |
|------|----------|------|
| `E001` | 文件名不符合规范 | 文件名包含非法字符 |
| `E002` | 缺少必需 Section | 缺少 H2 或 H4 section |
| `E003` | Section 顺序错误 | Section 出现顺序不符合规范 |
| `E004` | Job 编号不连续 | Job 编号跳跃或重复 |
| `E005` | 依赖模块格式错误 | 依赖模块不符合格式要求 |
| `E006` | Task 格式错误 | Task 缺少编号或格式不正确 |
| `E007` | 前置条件格式错误 | Job 依赖格式不符合 job_N 规范 |
| `E008` | 完成状态标记无效 | 使用了不允许的状态标记 |
| `E009` | 调试日志格式错误 | debug 日志缺少必需字段 |
| `E010` | README 表格错误 | 模块列表表格格式不正确 |
| `E011` | 依赖关系不一致 | README 与模块文件中的依赖声明不一致 |
| `E012` | Jobs 数量不匹配 | README 中的 Jobs 数量与实际不符 |

---

## 9. 格式检查工具

### 9.1 命令行工具

```bash
# 检查单个文件
morty plan validate <file>

# 检查整个 plan 目录
morty plan validate

# 自动修复格式问题（如果可能）
morty plan validate --fix

# 输出详细报告
morty plan validate --verbose
```

### 9.2 输出格式

**成功**:
```
✅ Plan 格式验证通过

检查的文件: 3
  - user_auth.md: ✅ 通过
  - data_processor.md: ✅ 通过
  - [生产测试].md: ✅ 通过
```

**失败**:
```
❌ Plan 格式验证失败

user_auth.md:
  ❌ E004: Job 编号不连续 (第 45 行)
     发现: Job 3
     期望: Job 2
  ❌ E006: Task 格式错误 (第 52 行)
     发现: - [ ] 创建测试文件
     期望: - [ ] Task N: 创建测试文件

data_processor.md:
  ❌ E005: 依赖模块格式错误 (第 8 行)
     发现: **依赖模块**: UserAuth
     期望: **依赖模块**: user_auth

总计: 3 个错误
```

---

## 10. 迁移指南

### 10.1 从旧格式迁移

1. **运行格式检查**: `morty plan validate`
2. **查看错误报告**: 识别所有格式问题
3. **自动修复**: `morty plan validate --fix` (修复简单问题)
4. **手动修复**: 根据错误代码修复复杂问题
5. **重新验证**: 确保所有文件通过检查

### 10.2 常见迁移问题

| 旧格式 | 新格式 | 修复方法 |
|--------|--------|----------|
| `**依赖模块**:` | `**依赖模块**: 无` | 添加 `无` |
| `- [ ] 创建文件` | `- [ ] Task 1: 创建文件` | 添加 Task 编号 |
| 缺少完成状态 | `#### 完成状态\n\n⏳ 待开始` | 添加 section |
| `UserAuth` | `user_auth` | 转换为小写下划线 |

---

## 附录 A: 完整示例

参见: `examples/plan_format_example.md`

## 附录 B: 正则表达式速查

```regex
文件名: ^[a-z0-9_]+\.md$
模块名: ^[a-z0-9_]+$
依赖列表: ^([a-z0-9_]+(, [a-z0-9_]+)*|无|__ALL__)$
Job 标题: ^### Job \d+: .+$
Task: ^- \[([ x])\] Task \d+: .+$
Job 依赖: ^(job_\d+|[a-z0-9_]+:job_\d+)( - .+)?$
Debug 日志: ^debug\d+: .+, .+, .+, .+, .+, .+$
```
