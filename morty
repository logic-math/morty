#!/bin/bash
# Morty - Simplified AI Development Loop
# Unified command interface

set -e

VERSION="0.1.0"
MORTY_HOME="${MORTY_HOME:-$HOME/.morty}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Morty - Simplified AI Development Loop

Usage: morty <command> [options]

Commands:
    plan <prd.md> [name]    Interactive PRD refinement (generates project)
    enable                  Enable Morty in existing project
    start                   Start the development loop
    monitor                 Start with tmux monitoring
    status                  Show current status
    rollback <loop-number>  Rollback to specific loop iteration
    history                 Show loop history from git commits
    version                 Show version

Examples:
    morty plan requirements.md         # Refine PRD and generate project
    morty plan docs/prd.md my-app      # With custom project name
    morty enable                       # Enable in existing project
    morty start                        # Start development loop
    morty monitor                      # Start with monitoring
    morty rollback 5                   # Rollback to loop #5
    morty history                      # Show loop commit history

Workflow:
    1. morty plan <prd.md>            # Interactive PRD refinement
    2. cd <generated-project>          # Enter project directory
    3. morty monitor                   # Start development with monitoring
    4. morty rollback <N>              # Rollback if needed

EOF
}

show_version() {
    echo "Morty version $VERSION"
}

# Command routing
case "${1:-}" in
    plan)
        shift
        exec "$MORTY_HOME/morty_plan.sh" "$@"
        ;;
    enable)
        shift
        exec "$MORTY_HOME/morty_enable.sh" "$@"
        ;;
    start)
        shift
        exec "$MORTY_HOME/morty_loop.sh" "$@"
        ;;
    monitor)
        shift
        exec "$MORTY_HOME/morty_loop.sh" --monitor "$@"
        ;;
    status)
        shift
        exec "$MORTY_HOME/morty_loop.sh" --status "$@"
        ;;
    rollback)
        shift
        # Source common.sh for git functions
        source "$MORTY_HOME/lib/common.sh"
        if [[ -z "${1:-}" ]]; then
            echo -e "${RED}Error: Loop number required${NC}"
            echo "Usage: morty rollback <loop-number>"
            exit 1
        fi
        git_rollback "$1"
        ;;
    history)
        shift
        # Source common.sh for git functions
        source "$MORTY_HOME/lib/common.sh"
        git_loop_history
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
