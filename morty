#!/bin/bash
# Morty - 简化的 AI 开发循环
# 统一命令接口

set -e

VERSION="0.3.0"
MORTY_HOME="${MORTY_HOME:-$HOME/.morty}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Morty - 简化的 AI 开发循环

用法: morty <command> [options]

命令:
    fix <prd.md>            迭代式 PRD 改进(问题修复/功能增强/架构优化)
    loop [options]          启动开发循环(集成监控)
    reset [options]         版本回滚和循环管理
    version                 显示版本

示例:
    morty fix prd.md                   # 改进 PRD 并生成 .morty/ 目录
    morty fix docs/requirements.md     # 指定 PRD 文件路径
    morty loop                         # 启动带监控的开发循环(推荐)
    morty loop --max-loops 100         # 自定义最大循环次数
    morty loop --no-monitor            # 不启动监控,直接运行
    morty reset -l                     # 查看循环提交历史
    morty reset -c abc123              # 回滚到指定 commit
    morty reset -s                     # 查看当前状态

工作流程:
    1. morty fix <prd.md>              # 迭代式 PRD 改进
    2. 查看生成的 .morty/specs/*.md    # 检查模块规范
    3. morty loop                      # 启动循环(自动启动 tmux 监控)
    4. morty reset -l                  # 查看循环历史
    5. morty reset -c <commit>         # 回滚到指定版本
    6. 人工干预修改代码(可选)
    7. morty loop                      # 从当前状态继续

监控功能:
    默认情况下,loop 会在 tmux 中启动三面板监控:
    - 左侧(50%): 循环实时日志(项目进度)
    - 右上(30%): Claude Code 监控(Token 使用、错误、资源)
    - 右下(70%): 交互式命令行

    便捷命令: status, progress, logs, plan, help
    使用 Ctrl+B D 可以分离会话,循环将在后台继续运行。

EOF
}

show_version() {
    echo "Morty version $VERSION"
}

# Command routing
case "${1:-}" in
    fix)
        shift
        exec "$MORTY_HOME/morty_fix.sh" "$@"
        ;;
    loop)
        shift
        exec "$MORTY_HOME/morty_loop.sh" "$@"
        ;;
    reset)
        shift
        exec "$MORTY_HOME/morty_reset.sh" "$@"
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}错误: 未知命令 '$1'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
