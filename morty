#!/bin/bash
# Morty - Simplified AI Development Loop
# Unified command interface

set -e

VERSION="0.1.0"
MORTY_HOME="${MORTY_HOME:-$HOME/.morty}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

show_help() {
    cat << 'EOF'
Morty - Simplified AI Development Loop

Usage: morty <command> [options]

Commands:
    fix <prd.md>            迭代式 PRD 改进(问题修复/功能增强/架构优化)
    enable                  在现有项目中启用 Morty
    start                   启动开发循环
    monitor                 启动并带 tmux 监控
    status                  显示当前状态
    rollback <loop-number>  回滚到特定循环迭代
    history                 显示 git 提交中的循环历史
    version                 显示版本

示例:
    morty fix prd.md                   # 改进 PRD 并更新规范
    morty fix docs/requirements.md     # 指定 PRD 文件路径
    morty enable                       # 在现有项目中启用
    morty start                        # 启动开发循环
    morty monitor                      # 启动并监控
    morty rollback 5                   # 回滚到循环 #5
    morty history                      # 显示循环提交历史

工作流程:
    1. morty fix <prd.md>             # 迭代式 PRD 改进
    2. 查看生成的 specs/*.md           # 检查模块规范
    3. morty monitor                   # 启动开发并监控
    4. morty rollback <N>              # 必要时回滚

EOF
}

show_version() {
    echo "Morty version $VERSION"
}

# Command routing
case "${1:-}" in
    fix)
        shift
        exec "$MORTY_HOME/morty_fix.sh" "$@"
        ;;
    enable)
        shift
        exec "$MORTY_HOME/morty_enable.sh" "$@"
        ;;
    start)
        shift
        exec "$MORTY_HOME/morty_loop.sh" "$@"
        ;;
    monitor)
        shift
        exec "$MORTY_HOME/morty_loop.sh" --monitor "$@"
        ;;
    status)
        shift
        exec "$MORTY_HOME/morty_loop.sh" --status "$@"
        ;;
    rollback)
        shift
        # Source common.sh for git functions
        source "$MORTY_HOME/lib/common.sh"
        if [[ -z "${1:-}" ]]; then
            echo -e "${RED}Error: Loop number required${NC}"
            echo "Usage: morty rollback <loop-number>"
            exit 1
        fi
        git_rollback "$1"
        ;;
    history)
        shift
        # Source common.sh for git functions
        source "$MORTY_HOME/lib/common.sh"
        git_loop_history
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
