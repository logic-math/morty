# Plan: 生产测试

## 部署架构

### 目标环境

#### 开发环境
- **操作系统**: Linux/macOS
- **Shell**: Bash 4.0+
- **依赖**: Git 2.0+, Claude Code CLI, jq (可选)
- **配置**: 使用 `.morty/config.yaml` 项目级配置

#### 生产环境（Morty 自身部署）
- **发布方式**: GitHub Releases + 安装脚本
- **安装路径**: `$HOME/.morty/`
- **命令路径**: `$HOME/.local/bin/morty`
- **配置路径**: `$HOME/.mortyrc`

### 环境同构策略

#### 策略 1: 统一脚本语言
- 使用 Bash 4.0+ 作为唯一脚本语言
- 避免平台特定命令，使用 POSIX 兼容语法
- 关键路径使用变量 `$MORTY_HOME`

#### 策略 2: 依赖版本声明
- Git: >= 2.0
- Bash: >= 4.0
- 可选依赖检查（jq）

#### 策略 3: 配置模板化
- 提供 `.morty/config.yaml` 模板
- 环境特定值通过环境变量覆盖
- 使用 `config_validate()` 检查配置有效性

#### 策略 4: 安装脚本标准化
```bash
# install.sh 部署流程
1. 检查系统依赖 (bash, git)
2. 创建安装目录 ~/.morty/
3. 复制脚本文件
4. 创建命令软链接 ~/.local/bin/morty
5. 生成默认配置文件 ~/.mortyrc
6. 验证安装
```

### 部署流程

```yaml
deployment:
  steps:
    - name: "构建"
      command: "./scripts/build.sh"
      outputs: ["dist/morty.tar.gz"]

    - name: "单元测试"
      command: "./tests/run_all_tests.sh"
      requires: ["构建"]

    - name: "集成测试"
      command: "./tests/run_integration_tests.sh"
      requires: ["单元测试"]

    - name: "打包"
      command: "./scripts/package.sh"
      outputs: ["morty-2.0.0.tar.gz", "install.sh"]
      requires: ["集成测试"]

    - name: "发布"
      command: "./scripts/release.sh"
      requires: ["打包"]
```

## Jobs

---

### Job: 开发环境启动验证

**目标**: 确保 `morty doing` 启动的开发环境等价于生产环境

**前置条件**: 所有功能模块开发完成

**Tasks (Todo 列表)**:
- [ ] 验证 Bash 版本 >= 4.0
- [ ] 验证 Git 版本 >= 2.0
- [ ] 验证 Claude Code CLI 可执行
- [ ] 验证配置加载正确
- [ ] 验证日志目录可写

**验证器**:
- 运行 `bash --version` 应显示版本 >= 4.0
- 运行 `git --version` 应显示版本 >= 2.0
- 运行 `$CLAUDE_CODE_CLI --version` 应返回成功
- 运行 `morty config list` 应显示所有配置项
- `.morty/logs/` 目录应可写且 morty 有权限创建文件
- 所有依赖缺失时应显示友好的安装指导

**调试日志**:
- 无

---

### Job: 完整流程测试

**目标**: 验证 research → plan → doing 完整流程

**前置条件**: 开发环境启动验证通过

**Tasks (Todo 列表)**:
- [ ] 创建测试项目目录
- [ ] 运行 `morty research test-flow` 完成研究
- [ ] 运行 `morty plan` 生成计划
- [ ] 运行 `morty doing` 执行开发
- [ ] 运行 `morty stat` 查看进度
- [ ] 验证所有步骤成功完成

**验证器**:
- research 应生成 `.morty/research/test-flow.md`
- plan 应生成 `.morty/plan/` 目录和多个模块文件
- doing 应执行所有 Jobs 并标记为 COMPLETED
- `morty stat` 应正确显示整体进度和当前状态
- `morty stat --json` 应输出有效的 JSON
- 最终应生成有效的 Git 提交历史
- 日志文件应记录完整执行过程
- `.morty/status.json` 应包含完整的执行记录

**调试日志**:
- 无

---

### Job: 错误恢复测试

**目标**: 验证各种错误场景下的恢复能力

**前置条件**: 完整流程测试通过

**Tasks (Todo 列表)**:
- [ ] 测试 Plan 不存在时的错误提示
- [ ] 测试 Job 失败后的重试机制
- [ ] 测试执行中断后的状态恢复
- [ ] 测试 `morty stat` 状态查询
- [ ] 测试 Git 冲突处理
- [ ] 测试磁盘空间不足处理

**验证器**:
- Plan 不存在时，应提示 "请先运行 morty plan"
- Job 失败后应重试最多 3 次，然后标记为 BLOCKED
- 中断后重新运行 `morty doing` 应从断点继续
- `morty stat` 应显示正确的恢复后状态
- `morty stat --watch` 应实时刷新状态
- Git 冲突时应创建备份分支并提示用户
- 磁盘空间不足时应优雅退出并保留状态

**调试日志**:
- 无

---

### Job: 性能基准测试

**目标**: 验证系统在各种负载下的性能表现

**前置条件**: 错误恢复测试通过

**Tasks (Todo 列表)**:
- [ ] 测试大量模块（20+）的加载性能
- [ ] 测试大量 Jobs（100+）的执行性能
- [ ] 测试大体积日志文件的处理
- [ ] 测试长时间运行（模拟 100 次循环）
- [ ] 测试内存使用稳定性

**验证器**:
- 加载 20 个模块应在 1 秒内完成
- 单个 Job 执行（不含实际开发）应在 100ms 内完成
- 处理 10MB 日志文件不应导致明显卡顿
- 运行 100 次模拟循环后内存增长应 < 10MB
- CPU 使用率应保持在合理范围（平均 < 10%）

**调试日志**:
- 无

---

### Job: 兼容性测试

**目标**: 验证在不同环境下的兼容性

**前置条件**: 性能基准测试通过

**Tasks (Todo 列表)**:
- [ ] 在 Ubuntu 20.04/22.04 测试
- [ ] 在 macOS 测试
- [ ] 使用不同 Bash 版本测试（4.0, 5.0）
- [ ] 使用不同 Git 版本测试（2.0, 2.30）

**验证器**:
- 所有核心功能在 Ubuntu 20.04/22.04 正常工作
- 所有核心功能在 macOS 正常工作
- `morty stat` 在所有平台显示一致
- Bash 4.0 是最低要求版本，应显示警告但不阻止使用
- Git 2.0+ 是必需的，旧版本应提示升级

**调试日志**:
- 无

---

### Job: 安装和升级测试

**目标**: 验证安装和升级流程

**前置条件**: 兼容性测试通过

**Tasks (Todo 列表)**:
- [ ] 在新环境运行 install.sh
- [ ] 验证安装后命令可用
- [ ] 验证配置文件生成
- [ ] 测试从旧版本升级
- [ ] 测试卸载流程

**验证器**:
- install.sh 应成功运行并创建所有必要目录
- 安装后 `morty version` 应返回版本号
- `~/.mortyrc` 应包含有效配置
- 升级时应保留用户配置（合并而非覆盖）
- 卸载应清理所有安装文件（保留用户数据）

**调试日志**:
- 无

---

## 执行顺序

1. 开发环境启动验证
2. 完整流程测试
3. 错误恢复测试
4. 性能基准测试
5. 兼容性测试
6. 安装和升级测试

所有测试通过后，标记生产测试完成。
