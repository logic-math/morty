# 监控面板布局更新说明

## 概述

根据用户反馈,重新设计了 tmux 监控面板布局,将 Claude Code 监控作为主要面板,实时显示 Token 使用情况和系统状态。

## 新布局

```
┌──────────────────┬───────────────┐
│                  │ 循环日志(30%) │
│  Claude 监控     ├───────────────┤
│  (Token 使用)    │ 交互终端(70%) │
│  (50% 宽度)      │               │
└──────────────────┴───────────────┘
```

### 面板分配

**左侧面板(50% 宽度) - Claude Code 监控**
- 主要功能: 实时监控 Claude Code 运行状态
- 显示内容:
  - 📊 循环状态(state, loop_count, max_loops)
  - 📝 当前日志文件信息
  - 🔢 Token 使用情况(从日志中提取)
  - ⚠️ 最近错误(最后 3 条)
  - 🔗 Claude 会话 ID
  - 💻 系统资源(CPU/内存)
- 刷新频率: 每 5 秒
- 实现: 持续运行的监控脚本

**右上面板(30% 高度) - 循环实时日志**
- 主要功能: 显示循环执行的完整输出
- 显示内容:
  - Claude Code 的实时输出
  - 循环迭代信息
  - 任务执行过程
- 实现: tail -f 尾随最新日志文件
- 特点: 后台启动循环,日志自动跟随

**右下面板(70% 高度) - 交互式命令行**
- 主要功能: 用户交互和命令执行
- 可用空间: 70% 高度,提供充足的操作空间
- 便捷命令:
  - `status` - 显示循环状态
  - `progress` - 显示任务进度
  - `logs` - 查看最新日志(最后 30 行)
  - `plan` - 查看任务计划
  - `help` - 显示帮助信息
- 特点: 完整的 bash 功能,可以执行任何命令

## 与旧布局的对比

### 旧布局(v0.3.0 初始版本)
```
┌─────────────────┬──────────────┐
│                 │  实时日志    │
│  Loop 执行      ├──────────────┤
│  (60%)          │  状态 + Bash │
└─────────────────┴──────────────┘
```

**问题:**
- 左侧 Loop 执行占用大量空间但信息密度低
- 没有专门的 Claude Code 监控
- 无法实时查看 Token 使用情况
- 右下面板空间不足

### 新布局(v0.3.1)
```
┌──────────────────┬───────────────┐
│                  │ 循环日志(30%) │
│  Claude 监控     ├───────────────┤
│  (Token 使用)    │ 交互终端(70%) │
└──────────────────┴───────────────┘
```

**改进:**
- ✅ 专门的 Claude Code 监控面板
- ✅ 实时 Token 使用统计
- ✅ 更多交互式终端空间(70%)
- ✅ 循环在后台运行,不占用面板空间
- ✅ 更清晰的信息层次

## Token 监控实现

### 提取逻辑

Claude Code 在输出中通常包含 token 使用信息,格式如:
```
Token usage: 1234/200000
```

监控脚本通过以下方式提取:
```bash
token_info=$(grep -i "token" "$latest_log" | tail -5)
```

### 显示示例

```
🔢 Token 使用情况:
  Token usage: 45678/200000; 154322 remaining
  Token usage: 46123/200000; 153877 remaining
  Token usage: 46890/200000; 153110 remaining
```

这样用户可以:
- 实时看到每次迭代的 token 消耗
- 监控剩余 token 配额
- 及时发现异常高消耗

## 系统资源监控

除了 Claude Code 状态,还显示系统资源:

```
💻 系统资源:
  CPU: 15.3%
  内存: 4.2G/16G
```

这有助于:
- 监控系统负载
- 发现性能瓶颈
- 确保系统健康运行

## 便捷命令增强

在右下交互式终端中,新增了更多便捷命令:

### status
显示当前循环状态:
```bash
$ status

📊 当前状态:
  状态: running
  循环: 5 / 50
  消息: 执行循环 5
  时间: 2024-01-15T10:30:45Z
```

### progress
显示任务进度:
```bash
$ progress

📝 任务进度:
  总任务: 10
  已完成: 3
  待完成: 7
  进度: 30%
```

### logs
查看最新日志(最后 30 行):
```bash
$ logs

📋 最新日志 (最后 30 行):
[日志内容...]
```

### plan
查看任务计划:
```bash
$ plan

📋 任务计划:
- [x] 任务 1
- [x] 任务 2
- [ ] 任务 3
...
```

### help
显示帮助信息:
```bash
$ help

═══════════════════════════════════════════════════════════
便捷命令:
  status       - 显示循环状态
  progress     - 显示任务进度
  logs         - 查看最新日志
  plan         - 查看任务计划
  help         - 显示此帮助

快捷键:
  Ctrl+B [     进入滚动模式(查看历史)
  Ctrl+B 方向键 切换面板
  Ctrl+B D     分离会话(后台运行)
  Ctrl+B X     关闭当前面板
═══════════════════════════════════════════════════════════
```

## 技术实现细节

### 面板大小控制

使用 tmux resize-pane 精确控制:
```bash
# 左侧 Claude 监控 50%
tmux resize-pane -t "$SESSION_NAME:${BASE_WIN}.0" -x 50%

# 右上日志 30%
tmux resize-pane -t "$SESSION_NAME:${BASE_WIN}.1" -y 30%

# 右下终端自动占用剩余 70%
```

### 循环后台启动

循环不再在面板中直接运行,而是通过 nohup 后台启动:
```bash
nohup $LOOP_RUNNER > /dev/null 2>&1 &
```

优势:
- 不占用面板空间
- 不受面板关闭影响
- 更稳定的执行环境

### 监控脚本持续运行

Claude 监控脚本在 while true 循环中持续运行:
```bash
while true; do
    clear
    # 显示监控信息
    sleep 5
done
```

每 5 秒刷新一次,确保信息实时性。

## 用户体验改进

### 信息密度优化

**旧版本:**
- 左侧大面板但信息稀疏
- 需要切换面板查看不同信息
- Token 使用情况不可见

**新版本:**
- 左侧集中显示关键监控信息
- 一眼看到 Token 使用、错误、状态
- 右下充足空间用于交互

### 操作效率提升

**旧版本:**
- 需要切换到状态面板查看进度
- 需要手动 tail 日志查看输出
- 命令行空间不足

**新版本:**
- 便捷命令快速查看状态
- 日志自动尾随在右上
- 70% 空间用于命令行操作

### 监控可见性

**旧版本:**
- 不知道 Token 消耗情况
- 不知道循环是否卡住
- 错误信息不明显

**新版本:**
- 实时 Token 使用统计
- 循环状态清晰显示
- 最近错误醒目提示

## 使用场景

### 场景 1: 日常开发循环

```bash
# 启动循环
morty loop

# 观察左侧 Claude 监控面板
# - 看到 Token 使用情况
# - 确认循环正常运行
# - 没有错误发生

# 在右下终端执行命令
$ git status
$ git diff

# 分离会话让循环后台运行
Ctrl+B D
```

### 场景 2: 调试问题

```bash
# 启动循环
morty loop

# 左侧 Claude 监控显示错误
⚠️  最近错误:
  Error: Module not found: 'express'
  Failed to import module

# 在右下终端安装依赖
$ npm install express

# 查看日志确认问题解决
$ logs
```

### 场景 3: 监控 Token 消耗

```bash
# 启动循环
morty loop

# 观察左侧 Claude 监控
🔢 Token 使用情况:
  Token usage: 45678/200000; 154322 remaining
  Token usage: 46123/200000; 153877 remaining

# Token 消耗过快,考虑优化提示词
# 或者暂停循环
Ctrl+C (在右下终端)
```

## 兼容性

### 向后兼容

- 所有原有的 `morty loop` 参数仍然有效
- `--no-monitor` 参数保留直接运行模式
- .morty/ 目录结构没有变化
- 便捷命令是新增的,不影响原有功能

### 依赖要求

- **必需**: tmux (用于监控模式)
- **可选**: jq (用于 JSON 解析,提升显示效果)
- **可选**: top/free (用于系统资源监控)

## 后续改进计划

1. **Token 消耗预警**
   - 当 Token 使用超过阈值时高亮显示
   - 接近配额上限时发出警告

2. **历史统计**
   - 记录每次循环的 Token 消耗
   - 生成统计图表

3. **性能分析**
   - 记录每次循环的执行时间
   - 识别慢速迭代

4. **智能刷新**
   - 根据循环状态调整刷新频率
   - 活跃时更频繁,空闲时降低频率

5. **自定义布局**
   - 允许用户配置面板大小
   - 保存个人偏好设置

## 总结

这次面板布局重新设计主要解决了以下问题:

1. ✅ **Token 可见性** - 实时显示 Token 使用情况
2. ✅ **信息密度** - 关键监控信息集中在左侧
3. ✅ **操作空间** - 70% 高度用于交互式终端
4. ✅ **后台运行** - 循环在后台执行,不占用面板

用户现在可以:
- 一眼看到 Claude Code 的运行状态
- 实时监控 Token 消耗
- 在充足的空间中执行命令
- 通过便捷命令快速查看信息

这大大提升了使用 Morty 进行 AI 开发的体验和效率。
